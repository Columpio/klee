# Как пользоваться `klee_benchmark.py`

## Подготовка `KLEE`
Подразумевается, что `KLEE` собран в директории `build`.
Также можно собирать `KLEE` в другой директории, после чего указать ее инструменту с
помощью флага `--builddir`. Сам инструмент должен лежать в корневой директории проекта
(где он и так лежит).

`KLEE` должен быть собран с поддержкой `POSIX runtime` и `uClibc`.

## Формирование тестовой базы
`klee_benchmark.py` поддерживает тесты с [`SV-benchmarks`](https://gitlab.com/sosy-lab/benchmarking/sv-benchmarks)
и обычные тесты с инструментацией для `KLEE`. Тесты должны быть на `C` и не должны иметь неразрешенных символов,
за исключением символов библиотеки `C`, внутренних функций `KLEE` 
(`KLEE` instrinsics: `klee_make_symbolic`, `klee_assume` и.т.д.) и символов `POSIX API`.
Поэтому необходимо брать из `SV-benchmarks` файлы с расширением `.i` (обработанные препроцессором), то есть файлы,
которые указаны как исходные в спецификациях тестов (`.yml` файлы). Некоторые тесты из `SV-benchmarks` пока что не
запускаются (к примеру, драйвера `linux`).

В директории `benchmarks` уже есть произвольно выбранный набор тестов разной сложности из `SV-benchmarks`.

## Прочее
1. В `include/klee-test-comp.c` находятся определения разных функции `TestComp` для запуска тестов из `SV-benchmarks`
на `KLEE`.
2. Если еще не сделано, нужно внести в `KLEE` изменения из [этого коммита](https://github.com/klee/klee/commit/148a68df793fca84a36fefd8824ea54fdf6583f4).
3. Для работы требуются следующие вещи: `clang`, `llvm-link`, `gcc`, `gcov`, [`gcovr`](https://gcovr.com/en/stable/installation.html).

## Само использование
Пример использования:
```
./klee_benchmark.py --output coverage_output --klee-output klee_output --t 10 benchmarks
```
Эта команда запустит `KLEE` на тестах из директории `benchmarks` с ограничением в 10 секунд на работу
SMT-решателя и 10 секунд на работу интерпретатора `KLEE` и запишет данные о покрытии в формате `html`
в директорию `coverage_output`, и результат работы `KLEE` в директорию `klee_output`.
Директорию `--klee-output` указывать необязательно, если она не указана, сохраняется только информация о
покрытии.

На текущий момент, на воспроизведение сгенерированных тестов для записи информации о покрытии дается 10 секунд,
при этом на воспроизведение одного теста выделяется не больше 3 секунд. Эти параметры и вынос их в интерфейс
инструмента необходимо будет обсудить.

Инструмент выставляет ограничение по времени на решатель и интерпретатор `KLEE` внутри самого `KLEE`,
некорректная работа `KLEE` может привести к бесконечной работе инструмента (исправлю).

## (Дополнительно) Информация по unsat-ядрам.
Чтобы быстро получить информацию по unsat-ядрам, нужно просто исполнить инструмент
с `--klee-output`, после чего в директории с выводом `KLEE` исполнить
```
grep -r "of unsat" 
```
